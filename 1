import pytest
import time
import os
import json
import platform
import itertools
import sys
import threading
from typing import Optional, Dict, Any, List, Tuple
from playwright.sync_api import Browser, Page, expect

# ---------- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ–∫—Ä—É–∂–µ–Ω–∏–π ----------
ENVIRONMENTS: Dict[str, Dict[str, Any]] = {
    'corp': {
        'base_url': 'http://lk.corp.dev.ru',
        'login': 'rodnischev@safib.ru',
        'password': '1',
        'timeout': 45_000
    },
    'setup': {
        'base_url': 'http://office.setuplk.ru',
        'login': 'rodnischev@safib.ru',
        'password': '1',
        'timeout': 45_000
    }
}

# ---------- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –æ—Ç—á–µ—Ç–æ–≤ ----------
REPORTS_DIR = "test_reports"
os.makedirs(REPORTS_DIR, exist_ok=True)

# ---------- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–µ—Å—Ç–æ–≤ ----------
passed_tests: list = []
failed_tests: list = []
skipped_tests: list = []
test_durations: Dict[str, float] = {}
session_start_time: Optional[float] = None
test_start_times: Dict[str, float] = {}
pytest_config = None  # –ë—É–¥–µ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –≤ pytest_configure

# ---------- –õ–æ–∞–¥–µ—Ä –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ —Ç–µ—Å—Ç–∞ ----------
class Loader:
    def __init__(self):
        self.done = False
        self.spinner = itertools.cycle(['-', '/', '|', '\\'])
        self.thread = None

    def spin(self, test_name):
        while not self.done:
            sys.stdout.write(f"\r[ {next(self.spinner)} ] Running: {test_name}...")
            sys.stdout.flush()
            time.sleep(0.1)
        sys.stdout.write('\r' + ' ' * (len(test_name) + 50) + '\r')
        sys.stdout.flush()

    def start(self, test_name):
        self.done = False
        self.thread = threading.Thread(target=self.spin, args=(test_name,))
        self.thread.start()

    def stop(self):
        self.done = True
        if self.thread:
            self.thread.join()


loader = Loader()

# ---------- –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∏–∫—Å—Ç—É—Ä—ã ----------
@pytest.fixture(scope="session")
def browser_type_launch_args():
    """–ê—Ä–≥—É–º–µ–Ω—Ç—ã –∑–∞–ø—É—Å–∫–∞ –±—Ä–∞—É–∑–µ—Ä–∞."""
    slow_mo_value = int(os.getenv("SLOWMO", "0"))
    return {
        "headless": False,
        "args": ["--start-fullscreen"],
        "slow_mo": slow_mo_value
    }

@pytest.fixture(scope="session")
def browser_context_args():
    """–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –±—Ä–∞—É–∑–µ—Ä–∞."""
    return {
        "viewport": {"width": 1920, "height": 1080},
        "screen": {"width": 1920, "height": 1080}
    }

@pytest.fixture
def auth_page(browser: Browser, request) -> Page:
    """–§–∏–∫—Å—Ç—É—Ä–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏—è."""
    env = get_current_environment(request)
    config = ENVIRONMENTS[env]

    context = browser.new_context(
        viewport={"width": 1920, "height": 1080},
        screen={"width": 1920, "height": 1080}
    )
    page = context.new_page()
    page.set_default_timeout(config['timeout'])

    try:
        login_url = f"{config['base_url']}/Account/Login?returnUrl=%2FClientOrg"
        page.goto(login_url)

        locator = page.get_by_role("textbox", name="Email –∏–ª–∏ –õ–æ–≥–∏–Ω")

        # –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –ø—Ä–æ–±—É–µ–º –ø–æ "Email"
        if not locator.is_visible(timeout=2000):
            locator = page.get_by_role("textbox", name="Email")

        locator.fill(config['login'])

        page.get_by_role("textbox", name="–ü–∞—Ä–æ–ª—å").fill(config['password'])
        page.get_by_role("button", name="–í—Ö–æ–¥").click()

        expect(page).not_to_have_url(login_url, timeout=5000)
        yield page
    except Exception as e:
        # –î–µ–ª–∞–µ–º —Å–∫—Ä–∏–Ω—à–æ—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ
        screenshot_path = os.path.join(REPORTS_DIR, f"error_{time.strftime('%H%M%S')}.png")
        page.screenshot(path=screenshot_path, full_page=True)
        pytest.fail(f"–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å ({env}): {e}\n–°–∫—Ä–∏–Ω—à–æ—Ç: {screenshot_path}")
    finally:
        context.close()

# ---------- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ----------
def get_current_environment(request):
    """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–µ–∫—É—â–µ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –ø–æ –º–∞—Ä–∫–µ—Ä—É –∏–ª–∏ –∞—Ä–≥—É–º–µ–Ω—Ç—É."""
    # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∞—Ä–∫–µ—Ä —Ç–µ—Å—Ç–∞
    env_marker = request.node.get_closest_marker("environment")
    if env_marker and len(env_marker.args) > 0:
        env = env_marker.args[0]
        if env in ENVIRONMENTS:
            return env
        pytest.skip(f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ: {env}")

    # 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞—Ä–≥—É–º–µ–Ω—Ç –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
    env_arg = request.config.getoption("--env")
    if env_arg and env_arg in ENVIRONMENTS:
        return env_arg

    # 3. –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    return 'corp'

def get_system_info():
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–∏—Å—Ç–µ–º–µ."""
    return {
        "platform": platform.platform(),
        "python_version": platform.python_version(),
        "processor": platform.processor(),
        "system_time": time.strftime("%Y-%m-%d %H:%M:%S")
    }

# ---------- –•—É–∫–∏ pytest ----------
def pytest_addoption(parser):
    """–î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏."""
    parser.addoption(
        "--env",
        choices=list(ENVIRONMENTS.keys()),
        default='corp',
        help="–í—ã–±–æ—Ä –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è —Ç–µ—Å—Ç–æ–≤: corp –∏–ª–∏ setup"
    )
    # –î–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏—é –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∞ –æ—Ç—á–µ—Ç–∞
    parser.addoption(
        "--report-format",
        choices=["text", "html", "json", "all"],
        default="text",
        help="–§–æ—Ä–º–∞—Ç –æ—Ç—á–µ—Ç–∞: text, html, json, all"
    )
    # –î–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏—é –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤
    parser.addoption(
        "--screenshots",
        action="store_true",
        default=False,
        help="–°–æ—Ö—Ä–∞–Ω—è—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç—ã –¥–ª—è —É–ø–∞–≤—à–∏—Ö —Ç–µ—Å—Ç–æ–≤"
    )

def pytest_configure(config):
    """–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è pytest."""
    global pytest_config
    pytest_config = config

    config.addinivalue_line(
        "markers",
        "environment(name): –º–∞—Ä–∫–∏—Ä—É–µ—Ç —Ç–µ—Å—Ç –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è"
    )

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è –æ—Ç—á–µ—Ç–∞
    config._report_data = {
        "env": config.getoption("--env"),
        "start_time": time.time(),
        "system": get_system_info(),
        "tests": [],
        "stats": {
            "passed": 0,
            "failed": 0,
            "skipped": 0,
            "broken": 0,
            "total": 0
        },
        "screenshots": {}
    }

def pytest_sessionstart(session):
    """–ó–∞–ø–æ–º–∏–Ω–∞–µ–º –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —Å–µ—Å—Å–∏–∏."""
    global session_start_time
    session_start_time = time.time()

def pytest_runtest_protocol(item, nextitem):
    """–ó–∞–ø–æ–º–∏–Ω–∞–µ–º –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —Ç–µ—Å—Ç–∞ –∏ –≤—ã–≤–æ–¥–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º —Ç–µ—Å—Ç–µ."""
    test_name = item.nodeid
    test_start_times[test_name] = time.time()

    # –í—ã–≤–æ–¥–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º —Ç–µ—Å—Ç–µ —Å –ª–æ–∞–¥–µ—Ä–æ–º
    print(f"\n[ START ] {test_name}")
    loader.start(test_name)

    # –î–∞–µ–º pytest –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–µ—Å—Ç–∞
    result = None

    # –ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–µ—Å—Ç–∞ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
    loader.stop()

    return result

def pytest_runtest_logreport(report):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤."""
    if report.when != "call":
        return

    test_name = report.nodeid
    start_time = test_start_times.get(test_name, time.time())
    duration = time.time() - start_time
    test_durations[test_name] = duration

    # –í—ã–≤–æ–¥–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–µ—Å—Ç–∞
    if report.passed:
        status = "‚úì PASSED"
        color = "\033[92m"  # green
    elif report.failed:
        status = "‚úó FAILED"
        color = "\033[91m"  # red
    else:
        status = "‚ö† SKIPPED"
        color = "\033[93m"  # yellow

    reset_color = "\033[0m"
    print(f"\r{color}[ {status} ] {test_name} ({duration:.2f}s){reset_color}")

    # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –æ—Ç—á–µ—Ç
    test_data = {
        "name": test_name,
        "duration": duration,
        "status": report.outcome.upper(),
        "error": None,
        "screenshot": None
    }

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
    if report.failed:
        failed_tests.append(test_name)
        test_data["error"] = str(report.longrepr)
        pytest_config._report_data["stats"]["failed"] += 1

        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞ –ø—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏
        if pytest_config.getoption("--screenshots"):
            screenshot_name = f"failure_{test_name.split('::')[-1]}_{time.strftime('%H%M%S')}.png"
            screenshot_path = os.path.join(REPORTS_DIR, screenshot_name)

            # –ü–æ–ª—É—á–∞–µ–º page –∏–∑ —Ç–µ—Å—Ç–∞ (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω)
            page = getattr(report, "page", None)
            if page and hasattr(page, "screenshot"):
                try:
                    page.screenshot(path=screenshot_path, full_page=True)
                    test_data["screenshot"] = screenshot_path
                    pytest_config._report_data["screenshots"][test_name] = screenshot_path
                except Exception as e:
                    print(f"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–¥–µ–ª–∞—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç: {e}")

    elif report.passed:
        passed_tests.append(test_name)
        pytest_config._report_data["stats"]["passed"] += 1
    elif report.skipped:
        skipped_tests.append(test_name)
        pytest_config._report_data["stats"]["skipped"] += 1

    pytest_config._report_data["tests"].append(test_data)
    pytest_config._report_data["stats"]["total"] += 1

def pytest_sessionfinish(session, exitstatus):
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–æ–≤ –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ"""
    session_end_time = time.time()
    total_duration = session_end_time - session_start_time
    report_format = session.config.getoption("--report-format")

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    report_data = session.config._report_data
    report_data["total_duration"] = total_duration
    report_data["timestamp"] = time.strftime("%Y-%m-%d %H:%M:%S")
    report_data["stats"]["passed_percent"] = round(
        (report_data["stats"]["passed"] / report_data["stats"]["total"]) * 100, 1
    ) if report_data["stats"]["total"] > 0 else 0

    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç—ã
    formats = []
    if report_format == "all":
        formats = ["text", "html", "json"]
    else:
        formats = [report_format]

    for fmt in formats:
        if fmt == "text":
            generate_text_report(report_data)
        elif fmt == "html":
            generate_html_report(report_data)
        elif fmt == "json":
            generate_json_report(report_data)

    # –í—ã–≤–æ–¥ –≤ –∫–æ–Ω—Å–æ–ª—å
    print("\n========== –†–ï–ó–£–õ–¨–¢–ê–¢–´ –¢–ï–°–¢–û–í ==========")

    GREEN = "\033[92m"
    RED = "\033[91m"
    YELLOW = "\033[93m"
    RESET = "\033[0m"

    if passed_tests:
        print(f"{GREEN}‚úÖ PASSED:{RESET}")
        for name in passed_tests:
            print(f"  ‚úî {name} [{test_durations.get(name, 0):.2f}s]")

    if failed_tests:
        print(f"{RED}‚ùå FAILED:{RESET}")
        for name in failed_tests:
            print(f"  ‚úò {name} [{test_durations.get(name, 0):.2f}s]")
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Ç—å –∫ —Å–∫—Ä–∏–Ω—à–æ—Ç—É –µ—Å–ª–∏ –µ—Å—Ç—å
            screenshot = report_data["screenshots"].get(name)
            if screenshot:
                print(f"     –°–∫—Ä–∏–Ω—à–æ—Ç: {screenshot}")

    if skipped_tests:
        print(f"{YELLOW}‚ö† SKIPPED:{RESET}")
        for name in skipped_tests:
            print(f"  ‚ö† {name}")

    print(f"\n‚è± –û–±—â–µ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: {total_duration:.2f} —Å–µ–∫—É–Ω–¥")
    print(f"üèÅ –û–∫—Ä—É–∂–µ–Ω–∏–µ: {session.config.getoption('--env')}")
    print("========================================")

    # –í—ã–≤–æ–¥–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –æ—Ç—á–µ—Ç–∞—Ö
    if formats:
        print("\nüìä –û—Ç—á–µ—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤:")
        for fmt in formats:
            ext = fmt if fmt != "text" else "txt"
            pattern = f"report_*.{ext}"
            report_files = [f for f in os.listdir(REPORTS_DIR) if f.endswith(f".{ext}")]
            if report_files:
                print(f"  - {os.path.join(REPORTS_DIR, sorted(report_files)[-1])}")

# ---------- –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã –æ—Ç—á–µ—Ç–æ–≤ ----------
def generate_text_report(report_data: dict):
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –æ—Ç—á–µ—Ç–∞"""
    filename = os.path.join(REPORTS_DIR, f"report_{time.strftime('%Y%m%d_%H%M%S')}.txt")

    with open(filename, "w", encoding="utf-8") as f:
        f.write(f"–û–¢–ß–ï–¢ –û –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ò\n")
        f.write(f"–î–∞—Ç–∞/–≤—Ä–µ–º—è: {report_data['timestamp']}\n")
        f.write(f"–û–∫—Ä—É–∂–µ–Ω–∏–µ: {report_data['env']}\n")
        f.write(f"–û–±—â–µ–µ –≤—Ä–µ–º—è: {report_data['total_duration']:.2f} —Å–µ–∫\n")
        f.write(f"–°–∏—Å—Ç–µ–º–∞: {report_data['system']['platform']}\n")
        f.write(f"Python: {report_data['system']['python_version']}\n")

        f.write("\n===== –°–¢–ê–¢–ò–°–¢–ò–ö–ê =====\n")
        f.write(f"–í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤: {report_data['stats']['total']}\n")
        f.write(f"–£—Å–ø–µ—à–Ω–æ: {report_data['stats']['passed']} ({report_data['stats']['passed_percent']}%)\n")
        f.write(f"–ü—Ä–æ–≤–∞–ª–µ–Ω–æ: {report_data['stats']['failed']}\n")
        f.write(f"–ü—Ä–æ–ø—É—â–µ–Ω–æ: {report_data['stats']['skipped']}\n")

        f.write("\n===== –î–ï–¢–ê–õ–ò –¢–ï–°–¢–û–í =====\n")
        for test in report_data["tests"]:
            status_icon = "‚úì" if test["status"] == "PASSED" else "‚úó" if test["status"] == "FAILED" else "‚ö†"
            f.write(f"{status_icon} [{test['duration']:.2f}s] {test['name']}\n")
            if test["error"]:
                f.write(f"   –û–®–ò–ë–ö–ê: {test['error']}\n")
            if test["screenshot"]:
                f.write(f"   –°–ö–†–ò–ù–®–û–¢: {test['screenshot']}\n")
            f.write("\n")

def generate_html_report(report_data: dict):
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML –æ—Ç—á–µ—Ç–∞"""
    filename = os.path.join(REPORTS_DIR, f"report_{time.strftime('%Y%m%d_%H%M%S')}.html")

    # –°—Ç–∏–ª–∏ –¥–ª—è –æ—Ç—á–µ—Ç–∞
    styles = """
    <style>
        :root {
            --passed: #4CAF50;
            --failed: #F44336;
            --skipped: #FFC107;
            --border: #ddd;
            --light-gray: #f5f5f5;
            --dark-gray: #333;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f9f9f9;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #2c3e50, #4a6491);
            color: white;
            padding: 30px 40px;
            text-align: center;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto;
        }

        .summary {
            display: flex;
            justify-content: space-between;
            padding: 20px 40px;
            background-color: #f0f4f8;
            border-bottom: 1px solid var(--border);
        }

        .summary-item {
            text-align: center;
        }

        .summary-item h3 {
            font-size: 1.2rem;
            color: #555;
            margin-bottom: 5px;
        }

        .summary-item .value {
            font-size: 1.8rem;
            font-weight: bold;
        }

        .stats-cards {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 30px;
            flex-wrap: wrap;
        }

        .stat-card {
            flex: 1;
            min-width: 200px;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            color: white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card.passed { background: linear-gradient(135deg, var(--passed), #2E7D32); }
        .stat-card.failed { background: linear-gradient(135deg, var(--failed), #C62828); }
        .stat-card.skipped { background: linear-gradient(135deg, var(--skipped), #F9A825); }
        .stat-card.total { background: linear-gradient(135deg, #2196F3, #0D47A1); }

        .stat-card h3 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .stat-card p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .details {
            padding: 30px 40px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        th, td {
            padding: 15px 20px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background-color: #2c3e50;
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.9rem;
        }

        tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        tr:hover {
            background-color: #eef7ff;
        }

        .passed-row { border-left: 5px solid var(--passed); }
        .failed-row { border-left: 5px solid var(--failed); }
        .skipped-row { border-left: 5px solid var(--skipped); }

        .status {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
        }

        .status.passed { background-color: #e8f5e9; color: var(--passed); }
        .status.failed { background-color: #ffebee; color: var(--failed); }
        .status.skipped { background-color: #fff8e1; color: var(--skipped); }

        .error-details {
            background-color: #fff5f5;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
            font-family: 'Consolas', monospace;
            white-space: pre-wrap;
            font-size: 0.9rem;
            line-height: 1.4;
            color: #c00;
        }

        .screenshot-link {
            display: inline-block;
            margin-top: 10px;
            padding: 8px 15px;
            background-color: #e3f2fd;
            color: #1565c0;
            border-radius: 4px;
            text-decoration: none;
            font-weight: 500;
            transition: background 0.2s;
        }

        .screenshot-link:hover {
            background-color: #bbdefb;
        }

        .environment-info {
            background-color: #e8f4ff;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .system-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .system-info div {
            background-color: #f1f8ff;
            padding: 12px;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        footer {
            text-align: center;
            padding: 20px;
            color: #777;
            font-size: 0.9rem;
            border-top: 1px solid var(--border);
            background-color: #f8f9fa;
        }

        .progress-bar {
            height: 10px;
            background-color: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 20px;
        }

        .progress {
            height: 100%;
            background: linear-gradient(90deg, var(--passed), var(--passed));
            width: CALC_PERCENT%;
        }
    </style>
    """.replace("CALC_PERCENT", str(report_data["stats"]["passed_percent"]))

    # –°–±–æ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü—ã —Å —Ç–µ—Å—Ç–∞–º–∏
    tests_table = ""
    for i, test in enumerate(report_data["tests"], 1):
        status_class = test["status"].lower()
        status_text = "–ü–†–û–ô–î–ï–ù" if status_class == "passed" else "–ü–†–û–í–ê–õ–ï–ù" if status_class == "failed" else "–ü–†–û–ü–£–©–ï–ù"

        tests_table += f"""
        <tr class="{status_class}-row">
            <td>{i}</td>
            <td>{test['name']}</td>
            <td><span class="status {status_class}">{status_text}</span></td>
            <td>{test['duration']:.2f} —Å–µ–∫</td>
            <td>
        """

        if test["error"]:
            tests_table += f"<div class='error-details'>{test['error']}</div>"

        if test["screenshot"]:
            tests_table += f"<a href='{test['screenshot']}' class='screenshot-link' target='_blank'>–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç</a>"

        tests_table += "</td></tr>"

    # –°–±–æ—Ä–∫–∞ HTML
    html = f"""
    <!DOCTYPE html>
    <html lang="ru">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>–û—Ç—á–µ—Ç –æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏</title>
        {styles}
    </head>
    <body>
        <div class="container">
            <header>
                <h1>–û—Ç—á–µ—Ç –æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏</h1>
                <p class="subtitle">–ü–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ —Ç–µ—Å—Ç–æ–≤–æ–π —Å–µ—Å—Å–∏–∏</p>
            </header>

            <section class="summary">
                <div class="summary-item">
                    <h3>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</h3>
                    <p class="value">{report_data['timestamp']}</p>
                </div>
                <div class="summary-item">
                    <h3>–û–∫—Ä—É–∂–µ–Ω–∏–µ</h3>
                    <p class="value">{report_data['env']}</p>
                </div>
                <div class="summary-item">
                    <h3>–û–±—â–µ–µ –≤—Ä–µ–º—è</h3>
                    <p class="value">{report_data['total_duration']:.2f} —Å–µ–∫</p>
                </div>
            </section>

            <section class="stats-cards">
                <div class="stat-card total">
                    <h3>{report_data['stats']['total']}</h3>
                    <p>–í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤</p>
                </div>
                <div class="stat-card passed">
                    <h3>{report_data['stats']['passed']}</h3>
                    <p>–ü—Ä–æ–π–¥–µ–Ω–æ</p>
                </div>
                <div class="stat-card failed">
                    <h3>{report_data['stats']['failed']}</h3>
                    <p>–ü—Ä–æ–≤–∞–ª–µ–Ω–æ</p>
                </div>
                <div class="stat-card skipped">
                    <h3>{report_data['stats']['skipped']}</h3>
                    <p>–ü—Ä–æ–ø—É—â–µ–Ω–æ</p>
                </div>
            </section>

            <div class="progress-bar">
                <div class="progress" style="width: {report_data['stats']['passed_percent']}%"></div>
            </div>

            <section class="environment-info">
                <h2>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ</h2>
                <div class="system-info">
                    <div><strong>–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞:</strong> {report_data['system']['platform']}</div>
                    <div><strong>Python:</strong> {report_data['system']['python_version']}</div>
                    <div><strong>–ü—Ä–æ—Ü–µ—Å—Å–æ—Ä:</strong> {report_data['system']['processor']}</div>
                    <div><strong>–í—Ä–µ–º—è —Å–∏—Å—Ç–µ–º—ã:</strong> {report_data['system']['system_time']}</div>
                </div>
            </section>

            <section class="details">
                <h2>–î–µ—Ç–∞–ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤</h2>
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>–¢–µ—Å—Ç</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</th>
                            <th>–î–µ—Ç–∞–ª–∏</th>
                        </tr>
                    </thead>
                    <tbody>
                        {tests_table}
                    </tbody>
                </table>
            </section>

            <footer>
                <p>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å –ø–æ–º–æ—â—å—é Playwright –∏ Pytest</p>
                <p>–í—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: {time.strftime('%Y-%m-%d %H:%M:%S')}</p>
            </footer>
        </div>
    </body>
    </html>
    """

    with open(filename, "w", encoding="utf-8") as f:
        f.write(html)

def generate_json_report(report_data: dict):
    """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è JSON –æ—Ç—á–µ—Ç–∞"""
    filename = os.path.join(REPORTS_DIR, f"report_{time.strftime('%Y%m%d_%H%M%S')}.json")

    # –£–ø—Ä–æ—â–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏
    report = {
        "metadata": {
            "timestamp": report_data["timestamp"],
            "environment": report_data["env"],
            "total_duration": report_data["total_duration"],
            "system": report_data["system"]
        },
        "stats": report_data["stats"],
        "tests": [
            {
                "name": test["name"],
                "status": test["status"],
                "duration": test["duration"],
                "error": test["error"],
                "screenshot": test["screenshot"]
            } for test in report_data["tests"]
        ]
    }

    with open(filename, "w", encoding="utf-8") as f:
        json.dump(report, f, indent=4, ensure_ascii=False)
